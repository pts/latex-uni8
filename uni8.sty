%
% uni8.sty: Universal inputenc, fontend and babel for pdflatex + lualatex
% by pts@fazekas.hu at Fri Jan 11 15:48:05 CET 2019
%
% See README.txt for detailed documentation.
%
% * It sets up hyphenation patterns correctly for pdflatex and lualatex,
%   with or without fontspec.
% * It works with pdflatex and lualatex.
% * It works with hyperref.sty.
% * It works with color.sty and xcolor.sty.
% * It defines \ul for underlining text.
% * It sets the default fonts with [font=...] options.
% * It sets the input encoding with [inputenc=...] options.
% * It loads fontspec.sty with the [fontspec] option.
\ProvidesPackage{uni8}[2019/01/02 v0.02 Universal LaTeX inputenc and fontenc]

% Extra customization from .tex: \PassOptionsToPackage{hungarian}{babel}

% Defaults.
\def\@univ@font{cm}
\def\@univ@inputenc{utf8}\def\@univ@inputenc@isutfe{1}
\def\@univ@fontspec{0}

\DeclareOption{fontspec}{\def\@univ@fontspec{1}}
\DeclareOption{fontspec=yes}{\def\@univ@fontspec{1}}
\DeclareOption{fontspec=no}{\def\@univ@fontspec{0}}
\DeclareOption{inputenc=utf8}{\def\@univ@inputenc{utf8}\def\@univ@inputenc@isutfe{1}}
\DeclareOption{inputenc=utf8x}{\def\@univ@inputenc{utf8x}\def\@univ@inputenc@isutfe{1}}
\DeclareOption{inputenc=latin1}{\def\@univ@inputenc{latin1}\def\@univ@inputenc@isutfe{0}}
\DeclareOption{inputenc=latin2}{\def\@univ@inputenc{latin2}\def\@univ@inputenc@isutfe{0}}
\DeclareOption{font=cm}{\def\@univ@font{cm}}  % Preferred.
\DeclareOption{font=lm}{\def\@univ@font{cm}}
\DeclareOption{font=ec}{\def\@univ@font{cm}}
\DeclareOption{font=lmodern}{\def\@univ@font{cm}}
\DeclareOption{font=tg}{\def\@univ@font{times}}
\DeclareOption{font=times}{\def\@univ@font{times}}  % Preferred.
\DeclareOption{font=old-times}{\def\@univ@font{oldtimes}}  % Preferred.
\DeclareOption{font=oldtimes}{\def\@univ@font{oldtimes}}
\DeclareOption{nop}{}
\ProcessOptions\relax

% if #1 specifies an UTF-8 encoding, runs #2, otherwise runs #3.
% @param #1 a control sequence.
\def\@univ@ifutfe#1#2#3{%
  \ifx#1\@univ@ifutfe@a
    #2%
  \else
    \ifx#1\@univ@ifutfe@b#2\else#3\fi
  \fi}
\def\@univ@ifutfe@a{utf8}
\def\@univ@ifutfe@b{utf8x}

\expandafter\ifx\csname opt@babel.sty\endcsname\relax
  % english is the default language (including default hyphenation) if
  % \PassOptionsToPackage{...}{babel} was not specified.
  \expandafter\def\csname opt@babel.sty\endcsname{english}\fi

\if1\@univ@fontspec
  \ifx\luatexversion\@undefined\PackageError{uni8}
      {[fontspec] needs to be run with lualatex}{}
    \def\@univ@fontspec{0}% Disable [fontspec] as a fallback.
  \fi
\fi
\if1\@univ@fontspec
  \@univ@ifutfe\@univ@inputenc{}{\PackageError{uni8}
      {[fontspec] conflicts with [inputenc=\@univ@inputenc].\MessageBreak
       Use [inputenc=utf8] with [fontspec]}{}\@@end}
  \def\reserved@a{cm}%
  \RequirePackage{babel}
  \RequirePackage{fontspec}  % lmodern font is the default for fontspec.
  % Override magyar.ldf loaded by babel.sty to prevent useless warning about
  % \usepackage{t1enc}.
  \def\magyar@sugg@to#1{}

  \def\@univ@font@cm{%  Latin Modern fonts, bettern than CM and EC for international text in T1 encoding.
    % Even though Latin Modern is the default text font for lualatex (see
    % fonttext.cfg in format generation time, it loads tulmr.fd), cmr is
    % still the default math font. By loading lmodern.sty we also change the
    % default math font to (non-Unicode) Latin Modern (e.g. lmmi10.pfb).
    \RequirePackage{lmodern}
  }
  \def\@univ@font@times{% TeX Gyre fonts, great alternative for Times, Helvetica and Courier.
    \RequirePackage{unicode-math}
    \setmainfont{TeX Gyre Termes}
    \setsansfont{TeX Gyre Heros}[Scale=MatchLowercase]
    \setmonofont{TeX Gyre Cursor}[Scale=MatchLowercase]
    \setmathfont{TeX Gyre Termes Math}
  }
  \def\@univ@font@oldtimes{% Times, Helvetica and Courier.
    \@univ@font@times  % old-times is not available in Unicode, using times.
  }
  \csname @univ@font@\@univ@font\endcsname
\else
  \ifx\luatexversion\@undefined
    % luainputenc would also work, but we don't want to depend on it, to
    % remain compatible with earlier versions of pdflatex.
    \expandafter\RequirePackage\expandafter[\@univ@inputenc]{inputenc}
  \else
    % Needed for ő and ű in non-fontspec fonts.
    \expandafter\RequirePackage\expandafter[\@univ@inputenc]{luainputenc}
  \fi
  \def\encodingdefault{T1}  % Part of t1enc.sty
  \fontencoding{T1}  % Part of t1enc.sty.
  % We don't run \selectfont here (t1enc.sty does), to avoid loading
  % ecrm1000.tfm here when it is not available (e.g. no
  % sudo apt-get install texlive-fonts-recommended).
  % TODO(pts): Add [font=tnr] for Times New Roman, Helvetica, Courier New.
  % TODO(pts): Add \pdfpageheight.
  \def\@univ@font@cm{%  Latin Modern fonts, bettern than CM and EC for international text in T1 encoding.
    \RequirePackage{lmodern}
  }
  \def\@univ@font@times{% TeX Gyre fonts, great alternative for Times, Helvetica and Courier.
    % Also changes math fonts. Load before tgtermes so that tgtermes can
    % change text fonts back.
    %
    % TODO(pts): Better with newtxtext and newtxmath?
    % https://tex.stackexchange.com/q/469726/820
    \RequirePackage{mathptmx}
    \RequirePackage{tgtermes}
    \RequirePackage{tgheros}
    \RequirePackage{tgcursor}
  }
  \def\@univ@font@oldtimes{% Times, Helvetica and Courier.
    % Ugly spacing of the accent in \H{o}. Use [font=times] instead.
    %
    % Doesn't affect math fonts.
    %\RequirePackage{times}
    % Also changes math fonts.
    \RequirePackage{mathptmx}
    % TODO(pts): Check txfonts.sty aand https://ctan.org/pkg/newtx as well.
  }
  \csname @univ@font@\@univ@font\endcsname

  % Without this lualatex wouldn't consider the characters ő and ű in font
  % encoding T1 as letters during hyphenation.
  %
  % This magic is based on https://tex.stackexchange.com/a/469909/820
  \@tempcnta128 \loop\ifnum\@tempcnta<159 \ifnum\lccode\@tempcnta=0
    \lccode\@tempcnta\@tempcnta\fi \advance\@tempcnta1 \repeat
  \@tempcnta160 \loop\ifnum\@tempcnta<190 \ifnum\lccode\@tempcnta=0
    \lccode\@tempcnta\@tempcnta\fi \advance\@tempcnta1 \repeat
  \@tempcnta192 \loop\ifnum\@tempcnta<256 \ifnum\lccode\@tempcnta=0
    \lccode\@tempcnta\@tempcnta\fi \advance\@tempcnta1 \repeat

  % Make loadhyph-hu.tex loaded by babel.sty in TeX Live 2019 load
  % hyph-hu.ec.tex rather than hyph-hu.tex in lualatex.
  %
  % This magic is based on https://tex.stackexchange.com/a/469909/820
  \let\kanjiskip\hsize
  % Without loading babel, hyphenation \language macros such as \l@english and
  % \l@hungarian wouldn't be defined in lualatex.
  \RequirePackage{babel}
  \let\kanjkiskip\@undefined  % Undo our hack above.
\fi

% Override magyar.ldf loaded by babel.sty to prevent useless warning about
% \usepackage[...]{inputenc}.
\def\magyar@sugg@ie#1{}

\edef\reserved@a{\csname inputencodingname\endcsname}
\@univ@ifutfe\reserved@a{\def\@univ@inputenc@isutfe{1}}{}

\ifnum10=\@univ@inputenc@isutfe\@univ@fontspec
  \IfFileExists{soulutf8.sty}{\IfFileExists{soul.sty}{
    % For non-utf8 input encodings, use \usepackage{soul}.
    \RequirePackage{soulutf8}
    \def\underline{\ul}  % \underline is built-in. Let's use soul's.
    \def\uline{\ul}  % \uline is from ulem. Let's use soul's.
  }{}}{}
\else
  \IfFileExists{soul.sty}{
    \usepackage{soul}
    \def\underline{\ul}  % \underline is built-in. Let's use soul's.
    \def\uline{\ul}  % \uline is from ulem. Let's use soul's.
  }{}
\fi

\endinput
